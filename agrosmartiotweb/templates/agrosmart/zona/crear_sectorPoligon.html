{% extends 'agrosmart/base.html' %}

{% block contenido %}
{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Sector</title>
    <style>
        /* Asegúrate de que el contenedor del mapa tenga un tamaño definido */
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
  <h2>Crear Sector</h2>
  <br>
  


  
  <form action="" autocomplete="off" class="formularioproceso" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <br>
    {{ form }}
    <p> Dibuja el sector en google maps </p>
    <div id="map"></div>
    
    <br>
    <br>

   
    <button type="submit" id="btnAgregar" class="btn btn-primary">Agregar Sector</button>

        {{mensaje}}

    </form>

    <script>
      let map;
      let drawingManager;
      let selectedShape;
  
      function initMap() {
          map = new google.maps.Map(document.getElementById("map"), {
              center: { lat: -34.397, lng: 150.644 },
              zoom: 8,
          });
  
          drawingManager = new google.maps.drawing.DrawingManager({
              drawingMode: google.maps.drawing.OverlayType.POLYGON,
              drawingControl: true,
              drawingControlOptions: {
                  position: google.maps.ControlPosition.TOP_CENTER,
                  drawingModes: ['polygon'],
              },
              polygonOptions: {
                  editable: true,
                  draggable: true,
              },
          });
  
          drawingManager.setMap(map);
  
          // Evento para capturar el polígono dibujado
          google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
              if (event.type === 'polygon') {
                  if (selectedShape) {
                      selectedShape.setMap(null);
                  }
                  selectedShape = event.overlay;
  
                  // Guardar las coordenadas del polígono en el campo oculto
                  document.getElementById('id_coordenadas').value = JSON.stringify(
                      selectedShape.getPath().getArray().map(coord => ({
                          lat: coord.lat(),
                          lng: coord.lng(),
                      }))
                  );
              }
          });
  
          // Escuchar cambios en el polígono para actualizar coordenadas en tiempo real
          google.maps.event.addListener(map, 'polygoncomplete', function(polygon) {
              google.maps.event.addListener(polygon.getPath(), 'set_at', updateCoordinates);
              google.maps.event.addListener(polygon.getPath(), 'insert_at', updateCoordinates);
          });
  
          function updateCoordinates() {
              document.getElementById('id_coordenadas').value = JSON.stringify(
                  selectedShape.getPath().getArray().map(coord => ({
                      lat: coord.lat(),
                      lng: coord.lng(),
                  }))
              );
          }
      }
  </script>
  

</body>
</html>

{% endblock %}
    